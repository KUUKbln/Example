<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎬 Cutlist</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #eee;
      margin: 0;
      padding: 1em;
    }

    h1, h2 {
      text-align: center;
    }

    iframe {
      width: 100%;
      max-width: 800px;
      height: 450px;
      display: block;
      margin: 1em auto;
      border: none;
    }

    .scene-buttons {
      margin-bottom: 2em;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .quote {
      text-align: center;
      font-style: italic;
      margin: 1em 0;
      white-space: pre-line;
    }

    details {
      background: #222;
      padding: 1em;
      margin: 1em auto;
      border-radius: 5px;
      max-width: 800px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      background: #111;
      color: #eee;
      border: 1px solid #444;
      padding: 1em;
      font-family: monospace;
      resize: vertical;
    }

    .controls {
      text-align: center;
      margin: 1em 0;
    }

    .controls button {
      margin: 0.5em;
      padding: 0.5em 1em;
      background: #333;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .controls button:hover {
      background-color: #555;
    }

    @media (max-width: 600px) {
      iframe {
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <h1>🎬 Cutlist Video Player</h1>

  <!--iframe id="ytplayer" src="" allow="autoplay" allowfullscreen></iframe-->
  <div id="ytplayer"></div>


  <div class="controls">
    <button onclick="toggleAutoPlay()">🔁 Auto: <span id="autoPlayStatus">AN</span></button>
  </div>

  <div class="scene-buttons" id="sceneButtons"></div>
  <div class="quote" id="sceneQuote">Szene nicht gestartet</div>

  <details open>
    <summary>📁 Geladene JSON bearbeiten</summary>
    <textarea id="cutlistEditor" spellcheck="false"></textarea>
    <div class="controls">
      <button onclick="applyCutlistFromEditor()">✅ Übernehmen</button>
      <button onclick="downloadCutlist()">⬇️ Download</button>
    </div>
  </details>

  <details>
    <summary>📌 Anleitung: Transkript per Bookmarklet laden</summary>
    <p>Benutze das Bookmarklet im YouTube-Transkript, um es zu kopieren und als Datei zu speichern. Lade diese Datei später in deinen Editor und verarbeite sie mit ChatGPT oder manuell.</p>
  </details>

  <details>
    <summary>🤖 Anleitung: Cutlist von ChatGPT erstellen lassen</summary>
    <p>Gib ChatGPT folgende Anleitung:</p>
    <pre><code>
Du erstellst eine Zusammenfassung für mehrere Youtube-Videos.
Bitte frage mich nach dem Thema und dann nach Transkript-Texten der Youtube-Videos.
Bitte erstelle daraus eine Cutlist mit Zitaten und Zeitangaben im folgenden JSON-Format:

{
  "videos": [...],
  "scenes": [...],
  "output": {
    "title": "...",
    "description": "...",
    "tags": [...],
    "notes": "..."
  }
}
    </code></pre>
  </details>

  <details>
    <summary>📐 Formatbeispiel für JSON-Cutlist</summary>
    <pre><code>{
  "videos": [
    {
      "title": "Titel",
      "youtubeID": "abc123",
      "youtubeURL": "https://youtube.com/watch?v=abc123",
      "summaryInstruction": "Zusammenfassung...",
      "transcriptPath": "transcripts/datei.txt",
      "localVideoPath": null
    }
  ],
  "scenes": [
    {
      "start": 10,
      "end": 20,
      "quote": "Zitat",
      "note": "Hinweis",
      "tags": ["Tag1"],
      "sourceVideoID": "abc123"
    }
  ],
  "output": {
    "title": "Projekt",
    "description": "Beschreibung",
    "tags": ["Tag1", "Tag2"],
    "notes": "Sonstige Hinweise"
  }
}</code></pre>
  </details>

  <script>
    let cutlistData = null;
    let autoPlay = true;
    let player = null;
    let currentSceneIndex = 0;
    let sceneTimer = null;

    function getCutlistFromQuery() {
      const params = new URLSearchParams(location.search);
      return params.get("cutlist");
    }

    async function loadCutlist(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error("Cutlist konnte nicht geladen werden.");
        return await res.json();
      } catch (e) {
        alert("❌ Fehler beim Laden der Cutlist: " + e.message);
        return null;
      }
    }

    async function init() {
      const cutlistFile = getCutlistFromQuery();
      if (!cutlistFile) {
        // Kein cutlist Parameter, lade Beispiel + Hinweis
        const example = {
          "videos": [{
            "title": "Beispielvideo",
            "youtubeID": "dQw4w9WgXcQ",
            "youtubeURL": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
            "summaryInstruction": "Beispielszene",
            "transcriptPath": "transcripts/example.txt",
            "localVideoPath": null
          }],
          "scenes": [{
            "start": 0,
            "end": 10,
            "quote": "Dies ist ein Beispielzitat.",
            "note": "Beispielszene ohne echte Daten",
            "tags": ["Beispiel"],
            "sourceVideoID": "dQw4w9WgXcQ"
          }],
          "output": {
            "title": "Beispiel-Projekt",
            "description": "Dies ist eine Beispiel-Cutlist, da keine geladen wurde.",
            "tags": ["Beispiel"],
            "notes": "Bitte lade eine Cutlist über ?cutlist=Datei.json"
          }
        };
        cutlistData = example;
        document.getElementById("cutlistEditor").value = JSON.stringify(example, null, 2);
        loadYouTubeAPI();
        return;
      }

      const data = await loadCutlist(cutlistFile);
      if (!data) return;

      cutlistData = data;
      document.getElementById("cutlistEditor").value = JSON.stringify(data, null, 2);
      loadYouTubeAPI();
    }

    function toggleAutoPlay() {
      autoPlay = !autoPlay;
      document.getElementById("autoPlayStatus").innerText = autoPlay ? "AN" : "AUS";
    }

    function loadYouTubeAPI() {
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.body.appendChild(tag);
    }


    function onYouTubeIframeAPIReady() {
     alert("APIReady");
      if (!cutlistData || !cutlistData.videos || cutlistData.videos.length === 0) {
        alert("❌ Keine Videos in Cutlist gefunden.");
        return;
      }
      const firstVideo = cutlistData.videos[0];
      if (!firstVideo.youtubeID) {
        alert("❌ Kein gültiges Video gefunden.");
        return;
      }

      player = new YT.Player('ytplayer', {
        height: '390',
        width: '640',
        videoId: firstVideo.youtubeID || 'dQw4w9WgXcQ',
        playerVars: {
          origin: window.location.origin,  // oder ganz weglassen
          enablejsapi: 1,
          modestbranding: 1,
          rel: 0,
          autoplay: 1
        },
        events: {
          'onReady': buildSceneLinks,
          'onStateChange': onPlayerStateChange,
        }
      });

      
      //alert("APIReady done");
    }



    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PAUSED && sceneTimer) {
        clearTimeout(sceneTimer);
      }
    }

    function playScene(index) {
      if (!cutlistData) return;

      const scene = cutlistData.scenes[index];
      const video = cutlistData.videos.find(v => v.youtubeID === scene.sourceVideoID);

      if (!video || !video.youtubeID) {
        alert("❌ Quelle nicht gefunden für Szene: " + scene.quote);
        return;
      }

      currentSceneIndex = index;
      document.getElementById("sceneQuote").innerText = `"${scene.quote}"\n💬 ${scene.note || ""}`;

      if (sceneTimer) clearTimeout(sceneTimer);

      player.loadVideoById({
        videoId: video.youtubeID,
        startSeconds: scene.start,
        endSeconds: scene.end
      });

      const duration = (scene.end - scene.start) * 1000;

      if (autoPlay) {
        sceneTimer = setTimeout(() => {
          if (currentSceneIndex + 1 < cutlistData.scenes.length) {
            playScene(currentSceneIndex + 1);
          } else {
            document.getElementById("sceneQuote").innerText = "🎉 Alle Szenen abgespielt.";
          }
        }, duration);
      }
    }

    function applyCutlistFromEditor() {
      try {
        const json = JSON.parse(document.getElementById("cutlistEditor").value);
        cutlistData = json;
        buildSceneLinks();
        alert("✅ Cutlist übernommen.");
      } catch (e) {
        alert("❌ Fehler beim Parsen des JSON: " + e.message);
      }
    }

    function downloadCutlist() {
      const text = document.getElementById("cutlistEditor").value;
      const blob = new Blob([text], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cutlist.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }


    function buildSceneLinks() {
      const container = document.getElementById("sceneButtons");
      container.innerHTML = "";

      cutlistData.scenes.forEach((scene, index) => {
        const video = cutlistData.videos.find(v => v.youtubeID === scene.sourceVideoID);
        if (!video) return;

        // Link mit Zeitangabe in Sekunden als Parameter (t=)
        const link = document.createElement("a");
        link.href = `https://www.youtube.com/watch?v=${video.youtubeID}&t=${Math.floor(scene.start)}s`;
        link.innerText = scene.quote;
        link.title = scene.note || "";
        link.target = "_blank";
        link.rel = "noopener noreferrer";

        link.style.display = "inline-block";
        link.style.margin = "5px";
        link.style.padding = "8px 12px";
        link.style.backgroundColor = "#333";
        link.style.color = "#fff";
        link.style.textDecoration = "none";
        link.style.borderRadius = "5px";

        link.onmouseover = () => {
          document.getElementById("sceneQuote").innerText = `"${scene.quote}"\n💬 ${scene.note || ""}`;
        };

        link.onmouseout = () => {
          document.getElementById("sceneQuote").innerText = `Szene nicht gestartet`;
        };

        container.appendChild(link);
      });
    }

    window.onload = init;
  </script>
</body>
</html>
